# UDML Specification for abk[observability] (Logging/Telemetry)
# This component handles structured logging and telemetry for sessions, LLM interactions, and errors

information:
  # Observability data structures
  - name: LogEntry
    description: "Structured log entry with context and metadata"
    schema:
      type: object
      properties:
        timestamp: { type: string, format: date-time }
        level: { type: string, enum: [trace, debug, info, warn, error] }
        message: { type: string }
        component: { type: string }
        session_id: { type: string }
        operation_id: { type: string }
        metadata: { type: object }
        error_details: { type: object }

  - name: TelemetryEvent
    description: "Telemetry event for metrics and monitoring"
    schema:
      type: object
      properties:
        event_type: { type: string }
        timestamp: { type: string, format: date-time }
        session_id: { type: string }
        metrics: { type: object, additionalProperties: { type: number } }
        dimensions: { type: object, additionalProperties: { type: string } }
        tags: { type: array, items: { type: string } }

  - name: ObservabilityConfig
    description: "Configuration for logging and telemetry behavior"
    schema:
      type: object
      properties:
        log_level: { type: string, enum: [trace, debug, info, warn, error] }
        enable_file_logging: { type: boolean }
        enable_console_logging: { type: boolean }
        log_directory: { type: string }
        enable_telemetry: { type: boolean }
        telemetry_endpoint: { type: string }
        sampling_rate: { type: number }

access:
  # Observability access patterns
  - name: query_logs
    description: "Query log entries with filters"
    parameters:
      filters: 
        type: object
        properties:
          level: { type: string }
          component: { type: string }
          session_id: { type: string }
          time_range: 
            type: object
            properties:
              start: { type: string, format: date-time }
              end: { type: string, format: date-time }
          limit: { type: integer }
    returns:
      type: array
      items: { $ref: "#/definitions/LogEntry" }

  - name: get_telemetry_metrics
    description: "Retrieve aggregated telemetry metrics"
    parameters:
      metric_name: { type: string }
      time_range: 
        type: object
        properties:
          start: { type: string, format: date-time }
          end: { type: string, format: date-time }
      aggregation: { type: string, enum: [sum, avg, min, max, count] }
    returns:
      type: array
      items:
        type: object
        properties:
          timestamp: { type: string, format: date-time }
          value: { type: number }
          dimensions: { type: object }

  - name: get_system_health
    description: "Get current system health metrics"
    returns:
      type: object
      properties:
        status: { type: string, enum: [healthy, degraded, critical] }
        uptime_seconds: { type: integer }
        active_sessions: { type: integer }
        error_rate: { type: number }
        performance_metrics: { type: object }

manipulation:
  # Observability operations
  - name: log_event
    description: "Record a log entry"
    parameters: { $ref: "#/definitions/LogEntry" }
    creates: { $ref: "#/definitions/LogEntry" }

  - name: record_telemetry
    description: "Record a telemetry event"
    parameters: { $ref: "#/definitions/TelemetryEvent" }
    creates: { $ref: "#/definitions/TelemetryEvent" }

  - name: update_observability_config
    description: "Update observability configuration at runtime"
    parameters:
      config_updates: { type: object }
    modifies: { $ref: "#/definitions/ObservabilityConfig" }

  - name: flush_logs
    description: "Force flush pending log entries to storage"
    modifies: { type: array, items: { $ref: "#/definitions/LogEntry" } }

extract:
  # Observability computations
  - name: analyze_error_patterns
    description: "Analyze error patterns from logs"
    input:
      type: array
      items: { $ref: "#/definitions/LogEntry" }
    output:
      type: object
      properties:
        error_frequency: { type: object, additionalProperties: { type: integer } }
        common_error_messages: { type: array, items: { type: string } }
        error_trends: { type: array, items: { type: object } }

  - name: calculate_performance_metrics
    description: "Calculate performance metrics from telemetry"
    input:
      type: array
      items: { $ref: "#/definitions/TelemetryEvent" }
    output:
      type: object
      properties:
        average_response_time: { type: number }
        throughput: { type: number }
        error_rate: { type: number }
        resource_utilization: { type: object }

  - name: generate_health_report
    description: "Generate comprehensive health report"
    input:
      type: object
      properties:
        logs: { type: array, items: { $ref: "#/definitions/LogEntry" } }
        telemetry: { type: array, items: { $ref: "#/definitions/TelemetryEvent" } }
        time_range: { type: object }
    output:
      type: object
      properties:
        overall_health: { type: string }
        issues: { type: array, items: { type: string } }
        recommendations: { type: array, items: { type: string } }
        metrics_summary: { type: object }

movement:
  # Observability data flow
  - name: log_routing
    description: "Route log entries to appropriate destinations"
    from: { $ref: "#/definitions/LogEntry" }
    to: ["console_output", "file_storage", "external_systems"]
    protocol: "structured_logging"
    boundaries: ["memory_to_persistence", "process_to_external"]

  - name: telemetry_export
    description: "Export telemetry data to monitoring systems"
    from: { $ref: "#/definitions/TelemetryEvent" }
    to: "telemetry_backend"
    protocol: "metrics_protocol"
    boundaries: ["application_to_monitoring"]

  - name: log_aggregation
    description: "Aggregate logs from multiple sources"
    from: "distributed_log_sources"
    to: "centralized_log_store"
    protocol: "log_shipping"
    boundaries: ["distributed_to_centralized"]

  - name: alert_generation
    description: "Generate alerts from log and telemetry analysis"
    from: "analyzed_data"
    to: "alerting_system"
    protocol: "alert_protocol"
    boundaries: ["analysis_to_notification"]

coordination:
  # Observability coordination
  - name: logging_pipeline
    description: "Coordinate log collection, processing, and storage"
    primitives:
      - type: "log_buffering"
        description: "Buffer logs for efficient batch processing"
      - type: "log_filtering"
        description: "Filter and sample logs based on configuration"
      - type: "log_rotation"
        description: "Manage log file rotation and retention"

  - name: telemetry_collection
    description: "Coordinate collection and transmission of telemetry"
    primitives:
      - type: "metric_aggregation"
        description: "Aggregate metrics before transmission"
      - type: "sampling_decisions"
        description: "Decide which telemetry to collect based on sampling"
      - type: "batch_transmission"
        description: "Batch telemetry for efficient transmission"

  - name: monitoring_integration
    description: "Integrate with external monitoring and alerting systems"
    primitives:
      - type: "health_checks"
        description: "Perform periodic health checks and report status"
      - type: "threshold_monitoring"
        description: "Monitor metrics against defined thresholds"
      - type: "incident_response"
        description: "Coordinate response to detected issues"